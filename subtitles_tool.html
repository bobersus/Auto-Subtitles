<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Subtitles Tool ‚Äî —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ò–ó –í–ò–î–ï–û (Whisper, –æ—Ñ—Ñ–ª–∞–π–Ω)</title>

  <!-- UI -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Roboto:wght@400;700&family=Montserrat:wght@400;600&family=Open+Sans:wght@400;600&family=Poppins:wght@400;600&family=Playfair+Display:wght@400;600&family=Fira+Sans:wght@400;600&family=Ubuntu:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220; --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.65); --border:rgba(255,255,255,.12);
      --accent:#7dd3fc; --danger:#fb7185; --ok:#34d399;

      --sub-font:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --sub-size:34px; --sub-color:#fff; --sub-bg:rgba(0,0,0,.35);
      --sub-shadow:0 2px 12px rgba(0,0,0,.55);
      --sub-stroke:1px; --sub-stroke-color:#000; --sub-y:86%;
      --anim-duration:.6s;
    }
    body{
      background: radial-gradient(1200px 600px at 20% 10%, rgba(125,211,252,.10), transparent 60%),
                  radial-gradient(900px 500px at 85% 35%, rgba(52,211,153,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .cardish{ background:var(--panel); border:1px solid var(--border); border-radius:16px; backdrop-filter: blur(10px); }
    .small-muted{ color:var(--muted); }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
    .badge-soft{ background:rgba(125,211,252,.14); color:rgba(255,255,255,.92); border:1px solid rgba(125,211,252,.25); }

    .video-wrap{
      position:relative; width:100%; aspect-ratio:16/9;
      background:rgba(255,255,255,.04); border:1px solid var(--border);
      border-radius:16px; overflow:hidden;
    }
    video{ width:100%; height:100%; object-fit:contain; background:#000; }

    #subOverlay{ position:absolute; inset:0; pointer-events:none; }
    #subBox{ position:absolute; left:50%; top:var(--sub-y); transform:translate(-50%,-50%); width:min(92%,980px); text-align:center; }
    #subText{
      display:inline-block;
      font-family:var(--sub-font); font-size:var(--sub-size); line-height:1.15; color:var(--sub-color);
      padding:.35em .6em; border-radius:14px; background:var(--sub-bg); box-shadow:var(--sub-shadow);
      text-shadow:
        calc(var(--sub-stroke) * 1) 0 0 var(--sub-stroke-color),
        calc(var(--sub-stroke) * -1) 0 0 var(--sub-stroke-color),
        0 calc(var(--sub-stroke) * 1) 0 var(--sub-stroke-color),
        0 calc(var(--sub-stroke) * -1) 0 var(--sub-stroke-color),
        0 2px 12px rgba(0,0,0,.55);
      opacity:0; will-change:transform,opacity;
    }

    .anim-fade{ animation:fadeIn var(--anim-duration) ease-out forwards; }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }

    .anim-bounce{ animation:bounceIn var(--anim-duration) cubic-bezier(.2,.9,.2,1.15) forwards; }
    @keyframes bounceIn{
      0%{opacity:0; transform:translateY(18px) scale(.98)}
      60%{opacity:1; transform:translateY(-6px) scale(1.01)}
      100%{opacity:1; transform:translateY(0) scale(1)}
    }

    .anim-scale{ animation:scaleUp var(--anim-duration) cubic-bezier(.2,.9,.2,1) forwards; }
    @keyframes scaleUp{ from{opacity:0; transform:scale(.8)} to{opacity:1; transform:scale(1)} }

    .anim-typewriter{ animation:fadeIn var(--anim-duration) ease-out forwards; }

    .form-control,.form-select{
      background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.12); color:rgba(255,255,255,.92);
    }
    .form-control:focus,.form-select:focus{
      background:rgba(255,255,255,.07); color:rgba(255,255,255,.95);
      border-color:rgba(125,211,252,.45); box-shadow:0 0 0 .2rem rgba(125,211,252,.15);
    }
    .btn-outline-light{ border-color:rgba(255,255,255,.18); }
    .alert{ background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.12); color:rgba(255,255,255,.92); }
    #statusDot{ display:inline-block; width:10px;height:10px;border-radius:50%; background:rgba(255,255,255,.35); margin-right:8px; }
    .dot-ok{ background:var(--ok)!important } .dot-warn{ background:#facc15!important } .dot-bad{ background:var(--danger)!important }
    table{ color:var(--text)!important }
    .table > :not(caption) > * > *{ background:transparent!important; border-color:rgba(255,255,255,.10)!important; }
    .table-hover tbody tr:hover{ background:rgba(255,255,255,.06)!important; }
  </style>
</head>

<body>
<div class="container py-4 py-md-5">
  <div class="d-flex align-items-start justify-content-between flex-wrap gap-3 mb-3">
    <div>
      <h1 class="mb-1">–ê–≤—Ç–æ-—Å—É–±—Ç–∏—Ç—Ä—ã <span class="badge badge-soft ms-2">–∏–∑ –≤–∏–¥–µ–æ ‚Ä¢ –æ—Ñ—Ñ–ª–∞–π–Ω Whisper</span></h1>
      <div class="small-muted">
        –í—Å—ë –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ù–∏–∫–∞–∫–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞. –ê—É–¥–∏–æ –∏–∑–≤–ª–µ–∫–∞–µ–º –∏–∑ –≤–∏–¥–µ–æ –∏ —Ä–∞—Å–ø–æ–∑–Ω–∞—ë–º –ª–æ–∫–∞–ª—å–Ω–æ.
      </div>
    </div>
    <div class="text-end small-muted">
      <div class="mono">subtitles_tool.html</div>
      <div>–õ—É—á—à–µ –Ω–∞ –ü–ö: <b>Chrome/Edge</b></div>
    </div>
  </div>

  <div class="alert alert-warning cardish mb-4">
    <b>–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ Whisper:</b> –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –±—Ä–∞—É–∑–µ—Ä —Å–∫–∞—á–∞–µ—Ç –º–æ–¥–µ–ª—å –ø–æ CDN (—Ç–æ–ª—å–∫–æ —ç—Ç–æ ‚Äú–≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç‚Äù).
    –î–∞–ª—å—à–µ –º–æ–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ù–∞ —Å–ª–∞–±—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—ã–º.
  </div>

  <div class="row g-3 mb-4">
    <div class="col-lg-5">
      <div class="cardish p-3 h-100">
        <h5 class="mb-2">1) –ó–∞–≥—Ä—É–∑–∫–∞</h5>
        <input id="videoInput" type="file" accept="video/*" class="form-control"/>
        <div class="small-muted mt-1">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: ‚â§ <b>60 —Å–µ–∫—É–Ω–¥</b></div>

        <div class="row g-2 align-items-end mt-2">
          <div class="col-7">
            <label class="form-label small-muted mb-1">–Ø–∑—ã–∫</label>
            <select id="langSelect" class="form-select">
              <option value="" selected>–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>
              <option value="ru">–†—É—Å—Å–∫–∏–π</option>
              <option value="en">English</option>
            </select>
          </div>
          <div class="col-5">
            <button id="genBtn" class="btn btn-primary w-100" disabled>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>

        <div class="mt-3 p-2 rounded" style="background:var(--panel2); border:1px solid var(--border);">
          <div class="d-flex align-items-center gap-2">
            <span id="statusDot"></span>
            <div>
              <div class="fw-semibold">–°—Ç–∞—Ç—É—Å</div>
              <div id="statusText" class="small-muted">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫.</div>
            </div>
          </div>
          <div class="progress mt-2" style="height:8px; background:rgba(255,255,255,.08);">
            <div id="progressBar" class="progress-bar" style="width:0%"></div>
          </div>
          <div class="small-muted mt-2">
            –ß–µ–º –∫–æ—Ä–æ—á–µ –≤–∏–¥–µ–æ –∏ —á–∏—â–µ —Ä–µ—á—å ‚Äî —Ç–µ–º –ª—É—á—à–µ.
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 mt-3">
          <button id="downloadSrtBtn" class="btn btn-outline-light" disabled>–°–∫–∞—á–∞—Ç—å SRT</button>
          <button id="downloadVttBtn" class="btn btn-outline-light" disabled>–°–∫–∞—á–∞—Ç—å VTT</button>
          <button id="resetBtn" class="btn btn-outline-light ms-auto">–°–±—Ä–æ—Å</button>
        </div>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="cardish p-3 h-100">
        <h5 class="mb-2">2) –ü—Ä–µ–≤—å—é + overlay</h5>
        <div class="video-wrap">
          <video id="video" controls playsinline></video>
          <div id="subOverlay">
            <div id="subBox"><div id="subText"></div></div>
          </div>
        </div>
        <div class="small-muted mt-2">
          Overlay —Ä–∏—Å—É–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö –≤–∏–¥–µ–æ. –°–µ–≥–º–µ–Ω—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –ø–æ —Ç–∞–π–º–∫–æ–¥–∞–º.
        </div>
      </div>
    </div>
  </div>

  <div class="cardish p-3 mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
      <h5 class="mb-0">3) –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—É–±—Ç–∏—Ç—Ä–æ–≤</h5>
      <div class="small-muted">–°—Ç–∏–ª–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.</div>
    </div>

    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label small-muted">–†–∞–∑–º–µ—Ä: <span id="fontSizeVal" class="mono"></span></label>
        <input id="fontSize" type="range" class="form-range" min="16" max="72" step="1"/>
      </div>
      <div class="col-md-3">
        <label class="form-label small-muted">Y: <span id="yPosVal" class="mono"></span></label>
        <input id="yPos" type="range" class="form-range" min="0" max="100" step="1"/>
      </div>
      <div class="col-md-3">
        <label class="form-label small-muted">–®—Ä–∏—Ñ—Ç</label>
        <select id="fontFamily" class="form-select">
          <option value="Inter">Inter</option>
          <option value="Roboto">Roboto</option>
          <option value="Montserrat">Montserrat</option>
          <option value="Open Sans">Open Sans</option>
          <option value="Poppins">Poppins</option>
          <option value="Playfair Display">Playfair Display</option>
          <option value="Fira Sans">Fira Sans</option>
          <option value="Ubuntu">Ubuntu</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label small-muted">–¶–≤–µ—Ç</label>
        <input id="textColor" type="color" class="form-control form-control-color w-100" value="#ffffff"/>
      </div>

      <div class="col-md-3">
        <label class="form-label small-muted">–§–æ–Ω (Œ±): <span id="bgAlphaVal" class="mono"></span></label>
        <input id="bgAlpha" type="range" class="form-range" min="0" max="0.85" step="0.05"/>
      </div>
      <div class="col-md-3">
        <label class="form-label small-muted">–û–±–≤–æ–¥–∫–∞: <span id="strokeVal" class="mono"></span></label>
        <input id="stroke" type="range" class="form-range" min="0" max="3" step="1"/>
      </div>
      <div class="col-md-3">
        <label class="form-label small-muted">–¶–≤–µ—Ç –æ–±–≤–æ–¥–∫–∏</label>
        <input id="strokeColor" type="color" class="form-control form-control-color w-100" value="#000000"/>
      </div>
      <div class="col-md-3">
        <label class="form-label small-muted">–¢–µ–Ω—å: <span id="shadowVal" class="mono"></span></label>
        <input id="shadow" type="range" class="form-range" min="0" max="1" step="0.05"/>
      </div>

      <div class="col-md-3">
        <label class="form-label small-muted">–ê–Ω–∏–º–∞—Ü–∏—è</label>
        <select id="animType" class="form-select">
          <option value="fade">Fade</option>
          <option value="bounce">Bounce</option>
          <option value="scale">Scale</option>
          <option value="typewriter">Typewriter</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label small-muted">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: <span id="animDurVal" class="mono"></span></label>
        <input id="animDuration" type="range" class="form-range" min="0.2" max="1.5" step="0.1"/>
      </div>
    </div>
  </div>

  <div class="cardish p-3 mb-5">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
      <h5 class="mb-0">4) –°–µ–≥–º–µ–Ω—Ç—ã</h5>
      <div class="small-muted">–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç, –∑–∞—Ç–µ–º —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å.</div>
    </div>

    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle mb-0">
        <thead>
          <tr class="small-muted">
            <th style="width:90px;">#</th>
            <th style="width:170px;">Start</th>
            <th style="width:170px;">End</th>
            <th>Text</th>
            <th style="width:170px;">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="segmentsTbody">
          <tr><td colspan="5" class="small-muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ========= Whisper (Transformers.js) =========
  –≠—Ç–æ –æ—Ñ—Ñ–ª–∞–π–Ω-–∏–Ω—Ñ–µ—Ä–µ–Ω—Å –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
  –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–∞—á–∏–≤–∞–µ—Ç –º–æ–¥–µ–ª—å –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ.
-->
<script type="module">
  import { pipeline, env } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2";

  // –í–ê–ñ–ù–û: –∫—ç—à –≤ –±—Ä–∞—É–∑–µ—Ä–µ (—á—Ç–æ–±—ã –º–æ–¥–µ–ª—å –Ω–µ –∫–∞—á–∞–ª–∞—Å—å –∑–∞–Ω–æ–≤–æ)
  env.useBrowserCache = true;
  env.allowLocalModels = false;

  // –î–∞–ª—å—à–µ ‚Äî —Ç–≤–æ–π –∫–æ–¥, –Ω–æ ensurePipeline —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç pipeline() –Ω–∞–ø—Ä—è–º—É—é:

  let asrPipeline = null;

  async function ensurePipeline(setStatus) {
    if (asrPipeline) return asrPipeline;

    const modelId = "Xenova/whisper-small"; // –º–æ–∂–Ω–æ tiny –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏

    const progress_callback = (p) => {
      if (typeof p?.progress === "number") {
        setStatus?.(`–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: ${p.status || "..."}`, "warn", 15 + Math.round(p.progress * 35));
      } else {
        setStatus?.("–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏‚Ä¶", "warn", 20);
      }
    };

    asrPipeline = await pipeline("automatic-speech-recognition", modelId, { progress_callback });
    return asrPipeline;
  }

  // üëâ –ù–∏–∂–µ –≤—Å—Ç–∞–≤—å –≤–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π JS —Ç–≤–æ–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  // (extractAudioPCM16kFromVideoFile, buildSegmentsFromWhisper, UI –∏ —Ç.–¥.)
  // –¢–æ–ª—å–∫–æ –≤ –º–µ—Å—Ç–µ –≤—ã–∑–æ–≤–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–π:
  // const pipe = await ensurePipeline(setStatus);
  // const result = await pipe(pcm16k, { return_timestamps: true, language: lang, task: "transcribe" });

</script>


<script>
  // ============================================================
  // State + helpers
  // ============================================================
  const el = (id) => document.getElementById(id);

  const ui = {
    videoInput: el("videoInput"),
    langSelect: el("langSelect"),
    genBtn: el("genBtn"),
    video: el("video"),
    subText: el("subText"),

    statusDot: el("statusDot"),
    statusText: el("statusText"),
    progressBar: el("progressBar"),

    downloadSrtBtn: el("downloadSrtBtn"),
    downloadVttBtn: el("downloadVttBtn"),
    resetBtn: el("resetBtn"),

    fontSize: el("fontSize"),
    yPos: el("yPos"),
    fontFamily: el("fontFamily"),
    textColor: el("textColor"),
    bgAlpha: el("bgAlpha"),
    stroke: el("stroke"),
    strokeColor: el("strokeColor"),
    shadow: el("shadow"),
    animType: el("animType"),
    animDuration: el("animDuration"),

    fontSizeVal: el("fontSizeVal"),
    yPosVal: el("yPosVal"),
    bgAlphaVal: el("bgAlphaVal"),
    strokeVal: el("strokeVal"),
    shadowVal: el("shadowVal"),
    animDurVal: el("animDurVal"),

    tbody: el("segmentsTbody"),
  };

  const DEFAULTS = {
    subFont: "Inter",
    subSize: 34,
    subY: 86,
    subColor: "#ffffff",
    subBgAlpha: 0.35,
    subStroke: 1,
    subStrokeColor: "#000000",
    subShadow: 0.55,
    animType: "fade",
    animDuration: 0.6,
  };

  const state = {
    videoLoaded: false,
    videoUrl: null,
    durationSec: 0,
    segments: [],
    nextSegId: 1,
    activeSegId: null,
    overlayRAF: null,

    // Whisper
    asrPipeline: null,
    running: false,
    lastTranscriptText: "",
  };

  function log(...args){ console.log("[WhisperSubTool]", ...args); }

  function setStatus(text, level="neutral", progress=null){
    ui.statusText.textContent = text;
    ui.statusDot.classList.remove("dot-ok","dot-warn","dot-bad");
    if(level==="ok") ui.statusDot.classList.add("dot-ok");
    if(level==="warn") ui.statusDot.classList.add("dot-warn");
    if(level==="bad") ui.statusDot.classList.add("dot-bad");
    if(progress !== null){
      ui.progressBar.style.width = Math.max(0, Math.min(100, progress)) + "%";
    }
  }

  function formatTimeSRT(seconds){
    const s = Math.max(0, seconds);
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = Math.floor(s%60);
    const ms = Math.floor((s - Math.floor(s))*1000);
    return `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")},${String(ms).padStart(3,"0")}`;
  }
  function formatTimeVTT(seconds){
    const s = Math.max(0, seconds);
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = Math.floor(s%60);
    const ms = Math.floor((s - Math.floor(s))*1000);
    return `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}.${String(ms).padStart(3,"0")}`;
  }
  function clampSegment(seg){
    const minGap = 0.2;
    seg.start = Math.max(0, seg.start);
    seg.end = Math.max(seg.start + minGap, seg.end);
    seg.text = (seg.text || "").replace(/\s+/g," ").trim();
    return seg;
  }
  function downloadTextFile(filename, content, mime="text/plain"){
    const blob = new Blob([content], {type: mime});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0);
  }
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ============================================================
  // Settings -> CSS vars
  // ============================================================
  function applySettings(){
    document.documentElement.style.setProperty("--sub-font", `"${ui.fontFamily.value}", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`);
    document.documentElement.style.setProperty("--sub-size", `${ui.fontSize.value}px`);
    document.documentElement.style.setProperty("--sub-y", `${ui.yPos.value}%`);
    document.documentElement.style.setProperty("--sub-color", ui.textColor.value);

    const alpha = parseFloat(ui.bgAlpha.value);
    document.documentElement.style.setProperty("--sub-bg", `rgba(0,0,0,${alpha})`);

    document.documentElement.style.setProperty("--sub-stroke", `${ui.stroke.value}px`);
    document.documentElement.style.setProperty("--sub-stroke-color", ui.strokeColor.value);

    const sh = parseFloat(ui.shadow.value);
    document.documentElement.style.setProperty("--sub-shadow", `0 2px 12px rgba(0,0,0,${sh})`);

    document.documentElement.style.setProperty("--anim-duration", `${parseFloat(ui.animDuration.value)}s`);

    ui.fontSizeVal.textContent = `${ui.fontSize.value}px`;
    ui.yPosVal.textContent = `${ui.yPos.value}%`;
    ui.bgAlphaVal.textContent = alpha.toFixed(2);
    ui.strokeVal.textContent = `${ui.stroke.value}px`;
    ui.shadowVal.textContent = sh.toFixed(2);
    ui.animDurVal.textContent = `${parseFloat(ui.animDuration.value).toFixed(1)}s`;
  }

  const settingInputs = [ui.fontSize, ui.yPos, ui.fontFamily, ui.textColor, ui.bgAlpha, ui.stroke, ui.strokeColor, ui.shadow, ui.animType, ui.animDuration];
  settingInputs.forEach(x => x.addEventListener("input", applySettings));
  settingInputs.forEach(x => x.addEventListener("change", applySettings));

  function resetSettings(){
    ui.fontFamily.value = DEFAULTS.subFont;
    ui.fontSize.value = DEFAULTS.subSize;
    ui.yPos.value = DEFAULTS.subY;
    ui.textColor.value = DEFAULTS.subColor;
    ui.bgAlpha.value = DEFAULTS.subBgAlpha;
    ui.stroke.value = DEFAULTS.subStroke;
    ui.strokeColor.value = DEFAULTS.subStrokeColor;
    ui.shadow.value = DEFAULTS.subShadow;
    ui.animType.value = DEFAULTS.animType;
    ui.animDuration.value = DEFAULTS.animDuration;
    applySettings();
  }
  resetSettings();

  // ============================================================
  // Video load + validation
  // ============================================================
  ui.videoInput.addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if(!file) return;

    cleanupSegmentsOnly();

    if(state.videoUrl) URL.revokeObjectURL(state.videoUrl);
    state.videoUrl = URL.createObjectURL(file);
    ui.video.src = state.videoUrl;

    setStatus("–ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ‚Ä¶", "neutral", 10);
    ui.genBtn.disabled = true;

    await new Promise((resolve) => {
      const on = () => { ui.video.removeEventListener("loadedmetadata", on); resolve(); };
      ui.video.addEventListener("loadedmetadata", on);
    });

    state.durationSec = ui.video.duration || 0;
    state.videoLoaded = true;

    if(!Number.isFinite(state.durationSec) || state.durationSec <= 0){
      setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.", "bad", 0);
      return;
    }
    if(state.durationSec > 60){
      setStatus(`–û—à–∏–±–∫–∞: ${state.durationSec.toFixed(1)} —Å–µ–∫. –ù—É–∂–Ω–æ ‚â§ 60 —Å–µ–∫.`, "bad", 0);
      return;
    }

    setStatus(`–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ (${state.durationSec.toFixed(1)} —Å–µ–∫). –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ –∏ –Ω–∞–∂–º–∏—Ç–µ ‚Äú–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å‚Äù.`, "ok", 0);
    updateGenState();
  });

  ui.langSelect.addEventListener("change", updateGenState);

  function updateGenState(){
    ui.genBtn.disabled = !(state.videoLoaded && ui.langSelect.value && state.durationSec <= 60 && !state.running);
  }

  // ============================================================
  // Whisper pipeline init + audio extraction
  // ============================================================
async function ensurePipeline(lang){
  const ok = await window.__ensureTransformersLoaded?.(setStatus);
if (!ok) {
  throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Transformers.js. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/–±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫/–ø–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä.");
}

  if (state.asrPipeline) return state.asrPipeline;

  setStatus("–ó–∞–≥—Ä—É–∂–∞–µ–º Whisper (–ø–µ—Ä–≤—ã–π —Ä–∞–∑ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–ª–≥–æ)‚Ä¶", "warn", 15);

  // ‚úÖ –í–ê–ñ–ù–û: –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≥–ª–æ–±–∞–ª –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
  const T =
    (typeof transformers !== "undefined" && transformers) ||
    (typeof window !== "undefined" && window.transformers) ||
    (typeof self !== "undefined" && self.transformers);

  if (!T || !T.pipeline) {
    console.error("Transformers.js –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ì–ª–æ–±–∞–ª:", { transformers: typeof transformers, w: window?.transformers });
    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è (Transformers.js). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/–±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫/–∑–∞–ø—É—Å–∫ –Ω–µ –≤ Safari.");
  }

  // (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ)
  T.env.allowLocalModels = false;
  T.env.useBrowserCache = true;

  const modelId = "Xenova/whisper-small";

  const progress_callback = (p) => {
    if (typeof p?.progress === "number") {
      setStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: ${p.status || "..."}`, "warn", 15 + Math.round(p.progress * 35));
    } else {
      setStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏‚Ä¶", "warn", 20);
    }
  };

  state.asrPipeline = await T.pipeline(
    "automatic-speech-recognition",
    modelId,
    { progress_callback }
  );

  console.log("Pipeline ready:", modelId);
  return state.asrPipeline;
}

  async function extractAudioPCM16kFromVideoFile(file){
    // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ –≤ AudioBuffer —á–µ—Ä–µ–∑ WebAudio
    setStatus("–ò–∑–≤–ª–µ–∫–∞–µ–º –∞—É–¥–∏–æ –∏–∑ –≤–∏–¥–µ–æ‚Ä¶", "ok", 55);

    const arrayBuf = await file.arrayBuffer();
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // decodeAudioData –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–æ–¥–µ–∫–∞—Ö ‚Äî —Ç–æ–≥–¥–∞ —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–µ–º
    let audioBuffer;
    try{
      audioBuffer = await audioCtx.decodeAudioData(arrayBuf.slice(0));
    }catch(err){
      log("decodeAudioData error:", err);
      try{ await audioCtx.close(); }catch(_){}
      throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ –¥–æ—Ä–æ–∂–∫—É (–∫–æ–¥–µ–∫/–±—Ä–∞—É–∑–µ—Ä). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –≤–∏–¥–µ–æ –∏–ª–∏ –ø–µ—Ä–µ–∫–æ–¥–∏—Ä—É–π—Ç–µ –≤ MP4 (AAC).");
    }

    // –ë–µ—Ä—ë–º –º–æ–Ω–æ (—Å–º–µ—à–∏–≤–∞–µ–º –∫–∞–Ω–∞–ª—ã)
    const sr = audioBuffer.sampleRate;
    const length = audioBuffer.length;
    const ch0 = audioBuffer.getChannelData(0);
    const ch1 = audioBuffer.numberOfChannels > 1 ? audioBuffer.getChannelData(1) : null;

    const mono = new Float32Array(length);
    if(ch1){
      for(let i=0;i<length;i++) mono[i] = 0.5*(ch0[i] + ch1[i]);
    } else {
      mono.set(ch0);
    }

    // Resample -> 16000 Hz (Whisper –ª—é–±–∏—Ç 16k)
    const targetSR = 16000;
    const ratio = targetSR / sr;
    const newLen = Math.round(length * ratio);
    const resampled = new Float32Array(newLen);

    // –ø—Ä–æ—Å—Ç–æ–π –ª–∏–Ω–µ–π–Ω—ã–π —Ä–µ—Å—ç–º–ø–ª–∏–Ω–≥ (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ä–µ—á–∏)
    for(let i=0;i<newLen;i++){
      const srcPos = i / ratio;
      const i0 = Math.floor(srcPos);
      const i1 = Math.min(i0 + 1, length - 1);
      const t = srcPos - i0;
      resampled[i] = mono[i0]*(1-t) + mono[i1]*t;
    }

    try{ await audioCtx.close(); }catch(_){}

    return resampled;
  }

  // ============================================================
  // Segments build from Whisper timestamps
  // ============================================================
  function buildSegmentsFromWhisper(result){
    // transformers whisper –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å:
    // - result.text
    // - result.chunks: [{text, timestamp:[start,end]}...]
    const chunks = result?.chunks || [];
    const segs = [];

    for(const c of chunks){
      if(!c?.text) continue;
      const ts = c.timestamp || c.timestamps || c.time || null;
      // –æ–∂–∏–¥–∞–µ–º [start,end]
      if(Array.isArray(ts) && ts.length >= 2){
        const start = Number(ts[0]);
        const end = Number(ts[1]);
        if(Number.isFinite(start) && Number.isFinite(end) && end > start){
          segs.push(clampSegment({
            id: state.nextSegId++,
            start,
            end,
            text: c.text
          }));
        }
      }
    }

    // –ï—Å–ª–∏ chunks –ø—É—Å—Ç—ã–µ ‚Äî fallback: –æ–¥–∏–Ω —Å–µ–≥–º–µ–Ω—Ç –±–µ–∑ —Ç–∞–π–º–∏–Ω–≥–æ–≤
    if(segs.length === 0 && result?.text){
      segs.push(clampSegment({
        id: state.nextSegId++,
        start: 0,
        end: Math.min(state.durationSec, 4),
        text: result.text
      }));
    }

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø–æ—Å—Ç-–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ/–Ω–∞—Ä–µ–∑–∫–∞ —á—Ç–æ–±—ã —Å–µ–≥–º–µ–Ω—Ç—ã –±—ã–ª–∏ ~1‚Äì4 —Å–µ–∫
    return normalizeSegments(segs);
  }

  function normalizeSegments(segs){
    if(segs.length === 0) return segs;

    const out = [];
    let cur = null;

    for(const s of segs){
      if(!cur){
        cur = {...s};
        continue;
      }
      const curLen = cur.end - cur.start;
      const nextLen = s.end - s.start;

      // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Å–µ–≥–º–µ–Ω—Ç –∫–æ—Ä–æ—Ç–∫–∏–π –∏ —Å–ª–µ–¥—É—é—â–∏–π —Ä—è–¥–æ–º ‚Äî –æ–±—ä–µ–¥–∏–Ω—è–µ–º
      if(curLen < 1.2 && (s.start - cur.end) < 0.35 && (cur.end - cur.start + nextLen) <= 4.2){
        cur.end = s.end;
        cur.text = (cur.text + " " + s.text).trim();
      } else {
        out.push(clampSegment(cur));
        cur = {...s};
      }
    }
    if(cur) out.push(clampSegment(cur));

    // –ü–µ—Ä–µ–Ω—É–º–µ—Ä—É–µ–º id –∞–∫–∫—É—Ä–∞—Ç–Ω–æ
    out.forEach((s, i) => s.id = i+1);
    state.nextSegId = out.length + 1;

    return out;
  }

  // ============================================================
  // Overlay sync + animations
  // ============================================================
  function startOverlayLoop(){
    if(state.overlayRAF) cancelAnimationFrame(state.overlayRAF);
    const tick = () => {
      const t = ui.video.currentTime || 0;
      const seg = findSegmentAtTime(t);
      if(seg){
        if(state.activeSegId !== seg.id){
          state.activeSegId = seg.id;
          showOverlayText(seg.text, true, seg.id);
        }
      } else {
        if(state.activeSegId !== null){
          state.activeSegId = null;
          hideOverlay();
        }
      }
      state.overlayRAF = requestAnimationFrame(tick);
    };
    state.overlayRAF = requestAnimationFrame(tick);
  }

  function findSegmentAtTime(t){
    for(const seg of state.segments){
      if(t >= seg.start && t <= seg.end) return seg;
    }
    return null;
  }

  function hideOverlay(){
    ui.subText.className = "";
    ui.subText.style.opacity = 0;
    ui.subText.textContent = "";
  }

  let typewriterToken = 0;
  function showOverlayText(text, isNew, segId=null){
    ui.subText.className = "";
    ui.subText.style.opacity = 0;
    document.documentElement.style.setProperty("--anim-duration", `${parseFloat(ui.animDuration.value)}s`);

    const type = ui.animType.value;
    if(!isNew){
      ui.subText.textContent = text;
      ui.subText.classList.add("anim-fade");
      return;
    }

    if(type === "fade"){
      ui.subText.textContent = text;
      ui.subText.classList.add("anim-fade");
    } else if(type === "bounce"){
      ui.subText.textContent = text;
      ui.subText.classList.add("anim-bounce");
    } else if(type === "scale"){
      ui.subText.textContent = text;
      ui.subText.classList.add("anim-scale");
    } else if(type === "typewriter"){
      ui.subText.textContent = "";
      ui.subText.classList.add("anim-typewriter");
      runTypewriter(text, parseFloat(ui.animDuration.value), segId);
    } else {
      ui.subText.textContent = text;
      ui.subText.classList.add("anim-fade");
    }
  }

  function runTypewriter(fullText, durSec, segId){
    const token = ++typewriterToken;
    const total = fullText.length;
    const durMs = Math.max(120, durSec * 1000);
    const stepMs = Math.max(12, durMs / Math.max(1, total));
    let i = 0;
    const iv = setInterval(() => {
      if(token !== typewriterToken){ clearInterval(iv); return; }
      if(segId !== null && state.activeSegId !== null && segId !== state.activeSegId){ clearInterval(iv); return; }
      i++;
      ui.subText.textContent = fullText.slice(0, i);
      if(i >= total) clearInterval(iv);
    }, stepMs);
  }

  // ============================================================
  // Table
  // ============================================================
  function renderSegmentsTable(){
    const segs = state.segments.slice().sort((a,b)=>a.start-b.start);
    if(segs.length === 0){
      ui.tbody.innerHTML = `<tr><td colspan="5" class="small-muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</td></tr>`;
      return;
    }
    ui.tbody.innerHTML = segs.map((seg, idx) => `
      <tr data-id="${seg.id}">
        <td class="mono">${idx+1}</td>
        <td class="mono">${formatTimeSRT(seg.start)}</td>
        <td class="mono">${formatTimeSRT(seg.end)}</td>
        <td>
          <div class="seg-text">${escapeHtml(seg.text)}</div>
          <div class="seg-edit d-none"><textarea class="form-control form-control-sm mt-1" rows="2">${escapeHtml(seg.text)}</textarea></div>
        </td>
        <td>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-sm btn-outline-light" data-action="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn btn-sm btn-outline-light d-none" data-action="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-sm btn-outline-light d-none" data-action="cancel">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-sm btn-outline-light" data-action="seek">‚ñ∂</button>
            <button class="btn btn-sm btn-outline-light" data-action="delete">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </td>
      </tr>
    `).join("");

    ui.tbody.querySelectorAll("tr").forEach(tr => {
      tr.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if(!btn) return;
        const action = btn.dataset.action;
        const id = parseInt(tr.dataset.id, 10);
        handleRowAction(tr, id, action);
      });
    });
  }

  function handleRowAction(tr, id, action){
    const seg = state.segments.find(s => s.id === id);
    if(!seg) return;

    const textDiv = tr.querySelector(".seg-text");
    const editWrap = tr.querySelector(".seg-edit");
    const textarea = tr.querySelector("textarea");

    const btnEdit = tr.querySelector('button[data-action="edit"]');
    const btnSave = tr.querySelector('button[data-action="save"]');
    const btnCancel = tr.querySelector('button[data-action="cancel"]');

    if(action === "edit"){
      textDiv.classList.add("d-none"); editWrap.classList.remove("d-none");
      btnEdit.classList.add("d-none"); btnSave.classList.remove("d-none"); btnCancel.classList.remove("d-none");
      textarea.focus(); return;
    }
    if(action === "cancel"){
      textarea.value = seg.text;
      textDiv.classList.remove("d-none"); editWrap.classList.add("d-none");
      btnEdit.classList.remove("d-none"); btnSave.classList.add("d-none"); btnCancel.classList.add("d-none");
      return;
    }
    if(action === "save"){
      seg.text = (textarea.value||"").replace(/\s+/g," ").trim();
      textDiv.textContent = seg.text || "(–ø—É—Å—Ç–æ)";
      textDiv.classList.remove("d-none"); editWrap.classList.add("d-none");
      btnEdit.classList.remove("d-none"); btnSave.classList.add("d-none"); btnCancel.classList.add("d-none");
      setStatus("–°–µ–≥–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—ë–Ω.", "ok", 100);
      return;
    }
    if(action === "seek"){
      ui.video.currentTime = seg.start;
      ui.video.play().catch(()=>{});
      setStatus(`–ü–µ—Ä–µ—Ö–æ–¥ –∫ ${formatTimeSRT(seg.start)}.`, "ok", 100);
      return;
    }
    if(action === "delete"){
      state.segments = state.segments.filter(s => s.id !== id);
      if(state.activeSegId === id){ state.activeSegId = null; hideOverlay(); }
      // –ø–µ—Ä–µ–Ω—É–º–µ—Ä—É–µ–º
      state.segments.forEach((s,i)=>s.id=i+1);
      state.nextSegId = state.segments.length + 1;
      renderSegmentsTable();
      ui.downloadSrtBtn.disabled = state.segments.length === 0;
      ui.downloadVttBtn.disabled = state.segments.length === 0;
      setStatus(`–£–¥–∞–ª–µ–Ω–æ.`, "ok", 100);
      return;
    }
  }

  // ============================================================
  // Export
  // ============================================================
  function exportSRT(segments){
    const segs = segments.slice().sort((a,b)=>a.start-b.start).map(clampSegment);
    let out = "";
    segs.forEach((seg, i) => {
      out += `${i+1}\n`;
      out += `${formatTimeSRT(seg.start)} --> ${formatTimeSRT(seg.end)}\n`;
      out += `${seg.text}\n\n`;
    });
    return out.trim() + "\n";
  }
  function exportVTT(segments){
    const segs = segments.slice().sort((a,b)=>a.start-b.start).map(clampSegment);
    let out = "WEBVTT\n\n";
    segs.forEach((seg) => {
      out += `${formatTimeVTT(seg.start)} --> ${formatTimeVTT(seg.end)}\n`;
      out += `${seg.text}\n\n`;
    });
    return out.trim() + "\n";
  }

  ui.downloadSrtBtn.addEventListener("click", () => {
    if(state.segments.length === 0) return;
    downloadTextFile("subtitles.srt", exportSRT(state.segments), "application/x-subrip;charset=utf-8");
  });
  ui.downloadVttBtn.addEventListener("click", () => {
    if(state.segments.length === 0) return;
    downloadTextFile("subtitles.vtt", exportVTT(state.segments), "text/vtt;charset=utf-8");
  });

  // ============================================================
  // Run generation (Whisper)
  // ============================================================
  ui.genBtn.addEventListener("click", async () => {
    if(state.running) return;
    const file = ui.videoInput.files?.[0];
    if(!file){ setStatus("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ.", "warn", 0); return; }
    if(!ui.langSelect.value){ setStatus("–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫.", "warn", 0); return; }
    if(state.durationSec > 60){ setStatus("–í–∏–¥–µ–æ > 60 —Å–µ–∫ ‚Äî –∑–∞–ø—Ä–µ—â–µ–Ω–æ.", "bad", 0); return; }

    state.running = true;
    updateGenState();
    ui.genBtn.textContent = "–†–∞–±–æ—Ç–∞—é‚Ä¶";
    ui.downloadSrtBtn.disabled = true;
    ui.downloadVttBtn.disabled = true;

    try{
      // 1) pipeline
      const lang = ui.langSelect.value; // ru / en
      const pipe = await ensurePipeline(lang);

      // 2) extract audio
      const pcm16k = await extractAudioPCM16kFromVideoFile(file);

      // 3) run ASR
      setStatus("–†–∞—Å–ø–æ–∑–Ω–∞—ë–º (Whisper, –æ—Ñ—Ñ–ª–∞–π–Ω)‚Ä¶", "ok", 75);

      // –í transformers.js –¥–ª—è whisper:
      // - return_timestamps: true -> chunks
      // - language: "ru"/"en"
      // - task: "transcribe"
      const result = await pipe(pcm16k, {
        return_timestamps: true,
        language: lang,
        task: "transcribe",
      });

      log("ASR result:", result);

      // 4) build segments
      setStatus("–°–æ–±–∏—Ä–∞–µ–º —Å–µ–≥–º–µ–Ω—Ç—ã‚Ä¶", "ok", 92);
      state.nextSegId = 1;
      state.segments = buildSegmentsFromWhisper(result);

      renderSegmentsTable();

      // 5) enable downloads
      ui.downloadSrtBtn.disabled = state.segments.length === 0;
      ui.downloadVttBtn.disabled = state.segments.length === 0;

      // 6) start overlay sync
      startOverlayLoop();

      setStatus(`–ì–æ—Ç–æ–≤–æ. –°–µ–≥–º–µ–Ω—Ç–æ–≤: ${state.segments.length}.`, "ok", 100);
    }catch(err){
      log("Generation error:", err);
      setStatus(`–û—à–∏–±–∫–∞: ${err?.message || err}`, "bad", 0);
    }finally{
      state.running = false;
      ui.genBtn.textContent = "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å";
      updateGenState();
    }
  });

  // ============================================================
  // Reset / cleanup
  // ============================================================
  ui.resetBtn.addEventListener("click", () => {
    cleanupSegmentsOnly();
    resetSettings();
    setStatus("–°–±—Ä–æ—à–µ–Ω–æ. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫.", "neutral", 0);
  });

  function cleanupSegmentsOnly(){
    state.segments = [];
    state.nextSegId = 1;
    state.activeSegId = null;
    renderSegmentsTable();
    hideOverlay();
    ui.downloadSrtBtn.disabled = true;
    ui.downloadVttBtn.disabled = true;
    ui.progressBar.style.width = "0%";
  }

  window.addEventListener("beforeunload", () => {
    if(state.videoUrl) URL.revokeObjectURL(state.videoUrl);
  });

  // ============================================================
  // Init defaults
  // ============================================================
  function initDefaultRanges(){
    ui.fontSize.value = DEFAULTS.subSize;
    ui.yPos.value = DEFAULTS.subY;
    ui.bgAlpha.value = DEFAULTS.subBgAlpha;
    ui.stroke.value = DEFAULTS.subStroke;
    ui.shadow.value = DEFAULTS.subShadow;
    ui.animDuration.value = DEFAULTS.animDuration;
    applySettings();
  }
  initDefaultRanges();

  // ============================================================
  // Overlay sync while playing (also works after generation)
  // ============================================================
  ui.video.addEventListener("play", () => startOverlayLoop());
  ui.video.addEventListener("seeked", () => startOverlayLoop());
</script>
</body>
</html>
